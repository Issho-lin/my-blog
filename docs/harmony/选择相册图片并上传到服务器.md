---
title: é¸¿è’™å¼€å‘å‘ç‚¹-ä¸Šä¼ å›¾ç‰‡
sidebar: 'auto'
sidebarDepth: 2
date: 2024-11-14
author: Issho Lin
tags:
 - é¸¿è’™å¼€å‘
categories:
 - é¸¿è’™å¼€å‘
---

## ä¸€ã€æ¨¡æ‹Ÿå™¨**<font style="color:rgb(51, 51, 51);">request.uploadFileæŠ¥é”™13400001ï¼Œfile operation error </font>**
### åŸå› ï¼š
ä½¿ç”¨æ¨¡æ‹Ÿå™¨ï¼Œå› ä¸ºæ¨¡æ‹Ÿå™¨å›¾åº“æ²¡æœ‰å›¾ç‰‡ï¼Œæ‰€ä»¥éœ€è¦ä»å¤–éƒ¨ä¸Šä¼ å›¾ç‰‡åˆ°ã€æ–‡ä»¶ç®¡ç†ã€‘ï¼Œç„¶åå†ä¿å­˜åˆ°å›¾åº“

### è§£å†³æ–¹æ¡ˆï¼š
1ã€å…³é—­æ¨¡æ‹Ÿå™¨ï¼Œæ¸…é™¤æ¨¡æ‹Ÿå™¨æ•°æ®ï¼Œç„¶åé‡å¯

![](https://cdn.nlark.com/yuque/0/2025/png/613071/1739241776064-1f2948e5-9b98-459c-bc34-88fb642eb723.png)

2ã€ğŸˆ²ä¸è¦æ‰“å¼€æ–‡ä»¶ç®¡ç†ï¼ï¼ğŸˆ²ä¸è¦æ‰“å¼€æ–‡ä»¶ç®¡ç†ï¼ï¼ğŸˆ²ä¸è¦æ‰“å¼€æ–‡ä»¶ç®¡ç†ï¼ï¼

![](https://cdn.nlark.com/yuque/0/2025/png/613071/1739242087799-277dce1a-6696-459d-927a-e6d483394f26.png)

2ã€ä½¿ç”¨æ¨¡æ‹Ÿå™¨è‡ªå¸¦çš„æˆªå›¾åŠŸèƒ½ç”Ÿæˆå›¾ç‰‡åˆ°å›¾åº“ï¼Œâš ï¸æ³¨æ„ï¼ï¼ä¸æ˜¯æ¨¡æ‹Ÿå™¨å³ä¾§å®ä½“æŒ‰é”®çš„æˆªå±æŒ‰é’®

![](https://cdn.nlark.com/yuque/0/2025/png/613071/1739241840480-75a469b9-5974-4701-8694-d4565f6d7769.png)

è€Œæ˜¯è¦ç”¨ä¸‹æ‹‰å·¥å…·æ çš„æˆªå±ï¼Œè¿™ä¸ªæ‰ä¼šæŠŠç”Ÿæˆçš„å›¾ç‰‡è‡ªåŠ¨ä¿å­˜åˆ°å›¾åº“é‡Œ

![](https://cdn.nlark.com/yuque/0/2025/png/613071/1739241939534-0815fbeb-716f-47b6-9fb1-d0598cb6850b.png)



## äºŒã€ç¡®ä¿å¼€å¯ç½‘ç»œæƒé™
```json
    "requestPermissions": [
      {
        "name": "ohos.permission.INTERNET",
      },
      {
        "name": "ohos.permission.READ_MEDIA",
        "reason": "$string:media_permission",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "inuse"
        }
      },
      {
        "name": "ohos.permission.WRITE_MEDIA",
        "reason": "$string:media_permission",
        "usedScene": {
          "abilities": [
            "EntryAbility"
          ],
          "when": "inuse"
        }
      }
    ],
```

## ä¸‰ã€å®Œæ•´ä»£ç 
```typescript
import { photoAccessHelper } from "@kit.MediaLibraryKit";
import ActionSheet, { Action } from './ActionSheet'
import PhotoViewer from './PhotoViewer'

@ComponentV2
  export default struct PhotoPicker {
    @Param maxCount: number = 1
    @Param value: string[] = []
    @Provider() showActionSheet: boolean = false
    @Local actions: Action[] = [{ key: 'preview', label: 'é¢„è§ˆ' }, { key: 'delete', label: 'åˆ é™¤' }]
    @Local actionIdx: number = 0
    @Local showPreview: boolean = false;
    @Event onChange?: (value: string[]) => void

    private onPreview() {
      this.showPreview = true
      this.showActionSheet = false
    }

    private onDelete() {
      const photoUris = this.value.filter((_, i) => i !== this.actionIdx)
      this.showActionSheet = false
      this.onChange?.(photoUris)
    }

    private onAction(key: string) {
      console.log('actionKey', key)
      if (key === 'delete') {
        this.onDelete()
      } else if (key === 'preview') {
        this.onPreview()
      }
    }
    build() {
      Row() {
        if (this.value.length) {
          ForEach(this.value, (item: string, index: number) => {
            Image(item)
              .width(82)
              .height(82)
              .borderRadius(8)
              .objectFit(ImageFit.Cover)
              .margin({ right: 15 })
              .onClick(() => {
                this.actionIdx = index
                this.showActionSheet = true
              })
          }, (item: string) => item)
        }
        Button('ä¸Šä¼ å›¾ç‰‡')
          .fontColor('#C5C6C7')
          .width(82)
          .height(82)
          .type(ButtonType.Normal)
          .backgroundColor('#F7F8F9')
          .borderRadius(8)
          .onClick(() => {
            const opt = new photoAccessHelper.PhotoSelectOptions();
            // è¿‡æ»¤é€‰æ‹©åª’ä½“æ–‡ä»¶ç±»å‹ä¸ºIMAGE
            opt.MIMEType = photoAccessHelper.PhotoViewMIMETypes.IMAGE_TYPE;
            // é€‰æ‹©åª’ä½“æ–‡ä»¶çš„æœ€å¤§æ•°ç›®
            opt.maxSelectNumber = this.maxCount - this.value.length;
            const photoPicker = new photoAccessHelper.PhotoViewPicker()
            photoPicker.select(opt).then(res => {
              const photoUris = Array.from(new Set([...this.value, ...res.photoUris]))
              this.onChange?.(photoUris)
            })
          })
        Row() {
          ActionSheet({ actions: this.actions, onAction: (key: string) => { this.onAction(key) } })
        }
        PhotoViewer({
          visible: this.showPreview,
          photoUris: this.value,
          current: this.actionIdx,
          onClose: () => { this.showPreview = false }
        })
      }
    }
  }
```

```typescript
import { BASE_URL } from './host'
import { promptAction } from '@kit.ArkUI';
import Store from '../store';
import { BusinessError, request as fileRequest } from '@kit.BasicServicesKit';
import { Context } from '@kit.AbilityKit';
import { fileIo } from '@kit.CoreFileKit';

export interface UploadConfig {
  url?: string
  fileUris: string[]
  filename?: string
  data?: { name: string, value: string }[]
  onProgress?: (uploadedSize: number, totalSize: number) => void
  onComplete?: (taskStates: Array<fileRequest.TaskState>) => void
  onSuccess?: (rst: IResponse<string>) => void
}
export async function uploadFile(context: Context, params: UploadConfig) {
  const url = params.url ?? '/account/app/file/upload'
  const name = params.filename ?? 'file'

  const files = params.fileUris.map(item => {
    const segments = item.split('/')
    const filename = segments[segments.length - 1]
    const type = filename.split('.')[1]
    const realUri = context.cacheDir + '/' + filename
    try {
      const file = fileIo.openSync(item, fileIo.OpenMode.READ_ONLY)
      fileIo.copyFileSync(file.fd, realUri)
      fileIo.closeSync(file)
    } catch (err) {

    }
    return { filename, name, uri: `internal://cache/${filename}`, type }
  })

  const token = Store.get('token')
  let uploadTask: fileRequest.UploadTask
  const uploadConfig: fileRequest.UploadConfig = {
    url: BASE_URL + '/api' + url,
    header: { 'content-type': 'multipart/form-data', Authorization: `Bearer ${token}`  },
    method: "POST",
    files,
    data: params.data ?? []
  };
  const uploadResult: { filePath: string, fileName: string }[] = []
  return new Promise<{ filePath: string, fileName: string }[]>((resolve, reject) => {
    fileRequest.uploadFile(context, uploadConfig).then((data: fileRequest.UploadTask) => {
      uploadTask = data
      uploadTask.on('progress', (uploadedSize: number, totalSize: number) => {
        params.onProgress?.(uploadedSize, totalSize)
      })
      uploadTask.on('complete', (taskStates: Array<fileRequest.TaskState>) => {
        params.onComplete?.(taskStates)
      })
      uploadTask.on('headerReceive', (rst: object) => {
        let bodyStr: string = rst['body']
        if (bodyStr) {
          let body: IResponse<string> = JSON.parse(bodyStr)
          params.onSuccess?.(body)
          if (body.code === 200) {
            const segments = body.data.split('/')
            const fileName = segments[segments.length - 1]
            uploadResult.push({
              filePath: body.data,
              fileName
            })
          } else {
            promptAction.showToast({ message: body.message, duration: 1500 })
            reject(new Error('upload fail message: ' + body.message))
            return
          }
          if (uploadResult.length === files.length) {
            resolve(uploadResult)
          }
        }
      });
    }).catch((err: BusinessError) => {
      reject(new Error(`Failed to request the download. Code: ${err.code}, message: ${err.message}`));
    })
  })
}
```

